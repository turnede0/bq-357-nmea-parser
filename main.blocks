<xml xmlns="https://developers.google.com/blockly/xml"><variables></variables><block type="pxt-on-start" id="y++WDKKG=9^Q|`nd_-NZ" x="20" y="20"><statement name="HANDLER"><block type="typescript_statement" id="p?!xQ5YU7k}UC(|QXhBf"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="namespace bq357 {" line1="    export enum Status {" line2="        //% block=&quot;Indoor (not fixed)&quot;" line3="        Indoor," line4="        //% block=&quot;Outdoor (position fixed)&quot;" line5="        Outdoor" line6="    }" line7="" line8="    export class Satellite {" line9="        constructor(" line10="            public type: string," line11="            public prn: number," line12="            public elevation: number," line13="            public azimuth: number," line14="            public snr: number" line15="        ) { }" line16="" line17="        //% blockCombine" line18="        get PRN(): number { return this.prn; }" line19="" line20="        //% blockCombine" line21="        get Elevation(): number { return this.elevation; }" line22="" line23="        //% blockCombine" line24="        get Azimuth(): number { return this.azimuth; }" line25="" line26="        //% blockCombine" line27="        get SNR(): number { return this.snr; }" line28="" line29="        //% blockCombine" line30="        get Type(): string { return this.type; }" line31="    }" line32="" line33="    // ────────────────────────────────────────────────" line34="    // Internal state" line35="    // ────────────────────────────────────────────────" line36="    let _fixed = false" line37="    let _utc = &quot;&quot;" line38="    let _lat = 0" line39="    let _ns = &quot;&quot;" line40="    let _lon = 0" line41="    let _ew = &quot;&quot;" line42="    let _speedKmh = 0" line43="" line44="    let _gpsSatellites: Satellite[] = []" line45="    let _beidouSatellites: Satellite[] = []" line46="" line47="    let _lastRawCycle: string = &quot;&quot;" line48="" line49="    let _moduleTxPin: SerialPin = null" line50="    let _moduleRxPin: SerialPin = null" line51="" line52="    // ────────────────────────────────────────────────" line53="    // Public blocks" line54="    // ────────────────────────────────────────────────" line55="" line56="    /**" line57="     * Set the pins connected to the BQ-357 module." line58="     * Must be called before log()." line59="     */" line60="    //% block=&quot;initialize BQ-357 pins|TX %txPin|RX %rxPin&quot;" line61="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line62="    export function initializePins(txPin: SerialPin, rxPin: SerialPin) {" line63="        _moduleTxPin = txPin" line64="        _moduleRxPin = rxPin" line65="        serial.redirectToUSB()  // ensure default output" line66="    }" line67="" line68="    /**" line69="     * Read one complete cycle of NMEA sentences from the module," line70="     * parse them, and store the raw text." line71="     * Serial is switched back to USB automatically." line72="     */" line73="    //% block=&quot;log latest NMEA cycle from module&quot;" line74="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line75="    export function log() {" line76="        if (!_moduleTxPin || !_moduleRxPin) {" line77="            serial.writeLine(&quot;Error: Call initializePins first&quot;)" line78="            return" line79="        }" line80="" line81="        serial.redirect(_moduleTxPin, _moduleRxPin, BaudRate.BaudRate9600)" line82="        basic.pause(50)" line83="" line84="        let lines: string[] = []" line85="        let maxLines = 20" line86="" line87="        // Clear satellite lists once per cycle" line88="        _gpsSatellites = []" line89="        _beidouSatellites = []" line90="" line91="        for (let i = 0; i &lt; maxLines; i++) {" line92="            let line = serial.readUntil(&quot;\n&quot;).trim()" line93="            // Replace startsWith with substr" line94="            if (line.length &gt;= 6 &amp;&amp; line.substr(0, 1) === &quot;$&quot;) {" line95="                lines.push(line)" line96="            }" line97="            basic.pause(8)" line98="        }" line99="" line100="        _lastRawCycle = lines.join(&quot;\n&quot;)" line101="        serial.redirectToUSB()" line102="" line103="        for (let line2 of lines) {" line104="            if (line2.length &gt;= 8) {" line105="                parseSingleLine(line2)" line106="            }" line107="        }" line108="    }" line109="" line110="    /**" line111="     * Returns the most recent full raw NMEA cycle (multi-line string)" line112="     */" line113="    //% block=&quot;last raw NMEA cycle (multi-line)&quot;" line114="    //% group=&quot;BQ-357 Debug&quot;" line115="    export function lastRawCycle(): string {" line116="        return _lastRawCycle || &quot;(no cycle captured yet)&quot;" line117="    }" line118="" line119="    //% block=&quot;BQ-357 module status&quot;" line120="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line121="    export function status(): Status {" line122="        return _fixed ? Status.Outdoor : Status.Indoor" line123="    }" line124="" line125="    //% block=&quot;UTC time (undefined when indoor)&quot;" line126="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line127="    export function utcTime(): string {" line128="        return _fixed &amp;&amp; _utc.length &gt; 0 ? _utc : &quot;undefined&quot;" line129="    }" line130="" line131="    //% block=&quot;latitude (undefined when indoor)&quot;" line132="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line133="    export function latitude(): string {" line134="        if (!_fixed || _lat === 0) return &quot;undefined&quot;" line135="        let deg = Math.idiv(_lat | 0, 100)" line136="        let min = _lat - deg * 100" line137="        let minScaled = Math.round(min * 10000)" line138="        let minStr = (minScaled / 10000).toString()" line139="        return deg + &quot;° &quot; + minStr + &quot;' &quot; + _ns" line140="    }" line141="" line142="    //% block=&quot;longitude (undefined when indoor)&quot;" line143="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line144="    export function longitude(): string {" line145="        if (!_fixed || _lon === 0) return &quot;undefined&quot;" line146="        let deg2 = Math.idiv(_lon | 0, 100)" line147="        let min2 = _lon - deg2 * 100" line148="        let minScaled2 = Math.round(min2 * 10000)" line149="        let minStr2 = (minScaled2 / 10000).toString()" line150="        return deg2 + &quot;° &quot; + minStr2 + &quot;' &quot; + _ew" line151="    }" line152="" line153="    //% block=&quot;speed km/h (undefined when indoor)&quot;" line154="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line155="    export function speed(): string {" line156="        return _fixed ? _speedKmh.toString() : &quot;undefined&quot;" line157="    }" line158="" line159="    //% block=&quot;list of visible GPS satellites&quot;" line160="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line161="    export function gpsSatellites(): Satellite[] {" line162="        return _gpsSatellites" line163="    }" line164="" line165="    //% block=&quot;list of visible Beidou satellites&quot;" line166="    //% group=&quot;BQ-357 GPS/Beidou&quot;" line167="    export function beidouSatellites(): Satellite[] {" line168="        return _beidouSatellites" line169="    }" line170="" line171="    // ────────────────────────────────────────────────" line172="    // Core parsing function" line173="    // ────────────────────────────────────────────────" line174="    function parseSingleLine(line: string) {" line175="        let fields = line.split(&quot;,&quot;)" line176="        if (fields.length &lt; 4) return" line177="" line178="        let sentenceId = fields[0].substr(fields[0].length - 5)" line179="" line180="        // ── RMC ───────────────────────────────────────────────" line181="        if (sentenceId.substr(sentenceId.length - 3) === &quot;RMC&quot; &amp;&amp; fields.length &gt;= 10) {" line182="            let status = fields[2] || &quot;V&quot;" line183="            _fixed = (status === &quot;A&quot;)" line184="" line185="            if (_fixed) {" line186="                // Time (hhmmss)" line187="                if (fields[1] &amp;&amp; fields[1].length &gt;= 6) {" line188="                    _utc = fields[1].substr(0, 6)" line189="                }" line190="                // Latitude" line191="                let latStr = fields[3] || &quot;&quot;" line192="                if (latStr !== &quot;&quot;) _lat = parseFloat(latStr)" line193="                _ns = fields[4] || &quot;&quot;" line194="                // Longitude" line195="                let lonStr = fields[5] || &quot;&quot;" line196="                if (lonStr !== &quot;&quot;) _lon = parseFloat(lonStr)" line197="                _ew = fields[6] || &quot;&quot;" line198="                // Speed" line199="                let knots = parseFloat(fields[7] || &quot;0&quot;)" line200="                _speedKmh = Math.round(knots * 1.852)" line201="            } else {" line202="                // Reset when no fix" line203="                _utc = &quot;&quot;" line204="                _lat = 0" line205="                _lon = 0" line206="                _ns = &quot;&quot;" line207="                _ew = &quot;&quot;" line208="                _speedKmh = 0" line209="            }" line210="        }" line211="" line212="        // ── GSV ───────────────────────────────────────────────" line213="        if (sentenceId.substr(sentenceId.length - 3) === &quot;GSV&quot; &amp;&amp; fields.length &gt;= 8) {" line214="            let system: string = null" line215="            if (fields[0].includes(&quot;GP&quot;)) system = &quot;GPS&quot;" line216="            else if (fields[0].includes(&quot;BD&quot;) || fields[0].includes(&quot;GB&quot;)) system = &quot;Beidou&quot;" line217="" line218="            if (system) {" line219="                let target = system === &quot;GPS&quot; ? _gpsSatellites : _beidouSatellites" line220="" line221="                let j = 4" line222="                while (j + 3 &lt; fields.length) {" line223="                    let prnStr = fields[j] || &quot;&quot;" line224="                    let elevStr = fields[j + 1] || &quot;&quot;" line225="                    let azStr = fields[j + 2] || &quot;&quot;" line226="                    let snrStr = fields[j + 3] || &quot;&quot;" line227="" line228="                    if (prnStr !== &quot;&quot;) {" line229="                        let prn = parseInt(prnStr)" line230="                        let elev = elevStr !== &quot;&quot; ? parseInt(elevStr) : 0" line231="                        let az = azStr !== &quot;&quot; ? parseInt(azStr) : 0" line232="                        let snr = snrStr !== &quot;&quot; ? parseInt(snrStr) : 0" line233="" line234="                        if (prn &gt; 0) {" line235="                            target.push(new Satellite(system, prn, elev, az, snr))" line236="                        }" line237="                    }" line238="                    j += 4" line239="                }" line240="            }" line241="        }" line242="    }" line243="}" numlines="244"></mutation></block></statement></block></xml>